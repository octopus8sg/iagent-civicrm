package com.novomind.ecom.app.iagent.custom.crm.training.shared;

// import java.util.Base64;

import com.novomind.ecom.api.iagent.exception.PersistencyException;
import com.novomind.ecom.api.iagent.exception.WrongTypeException;
import com.novomind.ecom.api.iagent.model.App;
import com.novomind.ecom.api.iagent.persistence.storage.Storage;
import com.novomind.ecom.common.api.frontend.CustomBean;
import org.json.JSONException;
import org.json.JSONObject;
import org.slf4j.Logger;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;

//import org.apache.http.HttpHeaders;
//

public class CrmTrainingConstants_ implements CustomBean {
//public class CrmTrainingConstants {

    @Inject
    private App app;
    @Inject
    private Logger log;

    // Issue info tab
    public static final String ISSUE_INFO_TAB_NAME = "crm_training";
    public static final String ISSUE_INFO_TAB_DISPLAY_NAME = "CiviCRM Connect";
    public static final String ISSUE_INFO_TAB_VIEW_URL = "/apps/crm/training/trainingCommon.xhtml";

    // Issue property
    public static final String ISSUE_PROPERTY_CONTACT_ID = "crmTrainingContactId";
    public static final String ISSUE_PROPERTY_CALLING_NUMBER = "callingnumber";
    public static final String ISSUE_PROPERTY_CONTACT_PHONE = "crmTrainingContactPhone";
    public static final String ISSUE_PROPERTY_CONTACT_NUMBER = "contactnumber";

    static String SITE;
    public static String CUSTOM_REST_API_GET_PATH; //
    public static String CUSTOM_REST_API_ENTITY; //
    public static String CUSTOM_REST_API_ACTION; //
    public static String CUSTOM_REST_API_JSON; //
    public static String CUSTOM_REST_API_ACCEPT_HEADER_VALUE;
    static String SITE_KEY;
    static String USER_KEY;
    static final String KEY_SITE = "site";
    static final String KEY_USER_KEY = "user_key";
    static final String KEY_SITE_KEY = "site_key";
    public static String CUSTOM_REST_API_AUTHORIZATION_VALUE;

    //    public static String CUSTOM_REST_API_AUTHORIZATION_VALUE =
//            String.format("key=%s&api_key=%s",
//                    SITE_KEY,
//                    USER_KEY);
//
    // CRM link
    public static String CRM_LINK_FORMAT;

    @PostConstruct
    public void init() throws PersistencyException {

        if (app != null) {
            Storage config = null;
            config = app.getConfig();

            if (config != null) {
                try {
                    SITE = config.getString(KEY_SITE);
                    USER_KEY = config.getString(KEY_USER_KEY);
                    SITE_KEY = config.getString(KEY_SITE_KEY);
                    CUSTOM_REST_API_AUTHORIZATION_VALUE =
                            String.format("key=%s&api_key=%s",
                                    SITE_KEY,
                                    USER_KEY);
                    CRM_LINK_FORMAT = "https://" +
                            SITE +
                            "/wp-admin/admin.php?page=CiviCRM&q=civicrm%%2Fcontact%%2Fview&reset=1&cid=%s";
                    CUSTOM_REST_API_ENTITY = "entity=Contact"; //
                    CUSTOM_REST_API_ACTION = "action=getsingle"; //
                    CUSTOM_REST_API_JSON = "json=1"; //
                    CUSTOM_REST_API_ACCEPT_HEADER_VALUE = "application/json";

                } catch (WrongTypeException e) {
                    log.warn("wrong type: ", e);
                }
            } else {
                log.warn("no storage");
            }
        } else {
            log.warn("no app");
        }
    }

    public static String getCrmApiLinkFromPhone(String phoneNumber) throws UnsupportedEncodingException {
        String payload = String.format("{\"phone\": \"%s\", \"return\": [\"id\"]}",
                phoneNumber);
        String params = URLEncoder.encode(payload, StandardCharsets.UTF_8.toString());
        var constants = new CrmTrainingConstants_();
        String crmApiLinkFromPhone = constants.CUSTOM_REST_API_GET_PATH +
                '?' + constants.CUSTOM_REST_API_ENTITY +
                '&' + constants.CUSTOM_REST_API_ACTION +
                '&' + constants.CUSTOM_REST_API_JSON +
                '&' + constants.CUSTOM_REST_API_AUTHORIZATION_VALUE +
                '&' + "json=" + params;
        return crmApiLinkFromPhone;
    }

    public static String getCrmContactIdFromPhone(String inner_contact_phone) throws IOException {
        String inner_contact_id = "";
        String urlString = CrmTrainingConstants_.getCrmApiLinkFromPhone(inner_contact_phone);
        URL url = new URL(urlString);
        HttpURLConnection con = (HttpURLConnection) url.openConnection();
        con.setRequestMethod("GET");
        CrmTrainingConstants_ constants = new CrmTrainingConstants_();
        con.setRequestProperty("Accept", constants.CUSTOM_REST_API_ACCEPT_HEADER_VALUE);
        int status = con.getResponseCode();
        BufferedReader in = new BufferedReader(
                new InputStreamReader(con.getInputStream()));
        String inputLine;
        StringBuffer content = new StringBuffer();
        while ((inputLine = in.readLine()) != null) {
            content.append(inputLine);
        }
        in.close();
//    if (content != null) {
        String strcontent = content.toString();
//    this.contactPhone = strcontent;
        try {
            var jsonObj = new JSONObject(strcontent);
            inner_contact_id = jsonObj.getString("contact_id");
        } catch (JSONException e) {
            e.printStackTrace();
        }
        return inner_contact_id;
    }

}
